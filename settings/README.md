

# Описание модуля в виде файла XML


## Module

Основная нода описания модуля. В атрибутах ноды **module** обязательно должны быть указаны тип базовой платы и тип мезонинной платы в полях *mtypeb* и *mtypem*, соответственно.

```xml
<module mtypeb="?" mtypem="?">
    <name>?</name>
    <version>?</version>
    <resources>?</resources>
</module>
```

* Элемент ***name*** отвечает за имя модуля, оно используется для отображения в редакторе модулей в ПО КОМА.
* Элемент ***version*** отвечает за минимальную подходящую версию ВПО модуля для данной конфигурации, записывается в виде `x.yy-zzzz`. 

### Resources

```xml
<resources>
	<alarms desc="Сигнализация"></alarms>
	<config desc="Конфигурация"></config>
	<iec60870 desc="Протокол ГОСТ Р МЭК 60870-5-104"></iec60870>
	<journals desc="Журналы"></journal>
	<modbus desc="Протокол Modbus"></modbus>
	<protocom desc="Протокол Protocom"></protocom>
	<section-tabs desc="Вкладки"></section-tabs>
	<sections desc="Разделы"></sections>
	<signals desc="Сигналы"></signals>
	<special desc="Дополнительно"></special>
</resources>
```

Нода **resources** может содержать:

* Ноду **alarms** - отвечает за сигнализацию;

* Ноду **config** - описывает конфигурацию модуля и всё с ней связанное;

* Ноду **iec60870** - описывает протокол МЭК 60870-5-104;

* Ноду **journals** - отвечает за журналы;

* Ноду **modbus** - описывает протокол Modbus RTU;

* Ноду **protocom** - описывает протокол Протоком;

* Ноду **section-tabs** - описывает владки для отображения текущих данных модуля;

* Ноду **sections** - описывает отображаемые сигналы во вкладках section-tabs;

* Ноду **signals** - описывает сигналы модуля;

* Ноду **special** - описывает диалоги, специфичные для конкретного модуля.

#### Alarms

```xml
	<alarms desc="Сигнализация">
		<critical desc="Критичные"/>
	                <item>
				<addr>?</addr>
				<string>?</string>
				<highlights>
					<item>?</item>
					<item>?</item>
				</highlights>
			</item>
		<warning desc="Предупреждения"/>
		<info desc="Информационные"/>
	</alarm>
```
Нода alarms может иметь секции следующих типов: *critical*, *info* или *warning*.

* Элемент ***addr*** типа quint32 отвечает за регистр (номер сигнала) сигнализации.
* Элемент ***string*** представляет собой описание сигнала, отображающееся в списке сигнализаций.
* Элемент *highlights* представляет собой список номеров сигналов, подсветка которых происходит при приходе данной сигнализации. В зависимости от секции - *warn* или *critical*, подсветка производится жёлтым или красным цветом, соответственно.

#### Config

Данный раздел отвечает за конфигурацию и значения по умолчанию для конфигурации.

```xml
<config>
	<record>
		<id>?</id>
		<defaultValue>?</defaultValue>
		<visibility>?</visibility>
		<count>?</count>
	</record>	
</config>
```

Раздел **config** может содержать неограниченное число элементов *record*, Каждый *record* соответствует одному элементу в конфигурации. Из всех элементов *record* формируется список необходимых для отображения элементов.

* Элемент ***id*** содержит идентификатор, необходим для формирования списка отображаемых элементов.
* Элемент *defaultValue* содержит значение по умолчанию для данного элемента. Если отсутствует, то считается равным 0 или  значению по умолчанию для типа этого элемента.
* Элемент *visibility* влияет на то, отображается данный элемент в диалоге конфигурирования или нет.
* Элемент *count* встречается только у тех записей, которые имеют различное описание у разных модулей с одним и тем же id, и содержит в себе число, характеризующее конкретное количество задаваемых параметров внутри одного элемента. Как пример: модули 0031 и 0033, у которых в параметре с id=235 "типы входов" задаются побитно одинаковым образом, но количество входов разное (11 и 30, соответственно).

#### Iec60870

В данном разделе описываются сигналы с точки зрения работы в протоколе МЭК 60870-5-104, а именно: группы и типы сигналов, а также типы опроса сигналов.

```xml
<iec60870 desc="Протокол ГОСТ Р МЭК 60870-5-104">
	<group>
		<signal-id>?</signal-id>
		<sig-type>?</sig-type>
		<trans-type>?</trans-type>
		<sig-group>?</sig-group>
	</group>
</iec60870>
```

* Элемент ***signal-id*** ссылается на элемент ***id*** в разделе **signals**, который описывает группу сигналов модуля;
* Элемент ***sig-type*** описывает тип сигнала (число) в терминах протокола МЭК 60870-5-104 (7, 30, 13 и т.д.)
* Элемент ***trans-type*** представляет собой число, характеризующее тип передачи в терминах протокола МЭК 60870-5-104: 0 - опрос группы, 1 - циклическая передача, 3 - спорадика. Элемент может не иметь значения для определённых типов передачи (например, команды)
* Элемент ***sig-group*** представляет собой номер группы опроса (если ***trans-type*** = 0)

#### Journals

Раздел описывает журналы, которые имеются в модуле. Журналы бывают трёх типов: Системный (*system*), Измерений (*meas*) и Событий (*work*). 

```xml
<journals desc="Журналы">
	<system desc="Системный журнал">
	</system>
	<meas desc="Журнал измерений">
		<header>?</header>
	</meas>
	<work desc="Рабочий журнал>
		<addr>?</addr>
		<desc>?</desc>
	</work>
</journals>
```
Системный журнал имеет одну и ту же структуру в любом из модулей, поэтому его описание сводится только к его наличию или отсутствию. Наличие определяется тем, есть ли элемент system в ноде journals.
* Элемент ***header*** содержит описание журнала;
* Элемент ***addr*** содержит адрес события, которое передаётся от модуля;
* Элемент ***desc*** представляет собой описание события для отображения в журнале.

Если любой из журналов отсутствует в модуле (например, журнал измерений в модулях АВ-ТУК), соответствующий элемент (например, meas) должен отсутствовать в разделе journals.

#### Modbus 

Данный элемент описывает использование протокола Modbus RTU. 
```xml
<modbus desc="Протокол Modbus">
	<group>
		<signal-id>?</signal-id>
		<reg-type>?</reg-type>
		<type>?</type>
	</group>
</modbus>
```
* Элемент ***signal-id***, как и в разделе **iec60870** ссылается на элемент ***id*** в разделе **signals**, который описывает группу сигналов модуля;
* Элемент ***reg-type*** описывает тип регистра в терминах протокола Modbus: 1 (Read Coils), 3 (Read Holding), 4 (Read Input), 5 (Write Coil), 6 (Write Single), 16 (Write Multiple);
* Элемент ***type*** содержит тип отображения сигналов в соответствующих окнах, может принимать значения: *bool*, *float*, *uint32*.

#### Protocom

В разделе описываются соответствия номеров блоков, получаемых по интерфейсу USB, и группы сигналов, описываемые в разделе **signals**.
```xml
<protocom desc="Протокол Protocom">
	<group>
		<block>?</block>
		<signal-id>?</signal-id>
	</group>
</protocom>
```
* Элемент ***block*** представляет собой номер блока, запрашиваемого у модуля;
* Элемент ***signal-id***, как и в разделе **iec60870** ссылается на элемент ***id*** в разделе **signals**, который описывает группу сигналов модуля.

#### Section-tabs
Раздел описывает вкладки, в которых отображаются текущие данные модуля при выборе пользователем основной вкладки "Текущие данные" на главном экране.
```xml
<section-tabs desc="Вкладки"?
	<tab>
		<id>?</id>
		<name>?</name>
	</tab>
</section-tabs>
```
* Элемент ***id*** - числовой идентификатор вкладки, на который ссылаются виджеты для определения принадлежности;
* Элемент ***name*** - название вкладки.

#### Sections
Раздел, описывающий отображение текущих данных, получаемых от модуля.
```xml
<sections desc="Разделы">
	<section header="?">
		<sgroup header="?" tab="?">
			<mwidget desc="?" view="?">
				<start-addr>?</start-addr>
				<count>?</count>
				<toolTip>?</toolTip>
				<string-array>
					<item>?</item>
					<item>?</item>
				</string-array>
			</mwidget>
		</sgroup>
	</section>
</sections>
```
Каждый сигнал, получаемый от модуля, может быть представлен в зависимости от указанных в данном разделе настроек различными способами. Для облегчения создания виджетов предусмотрена возможность объединения нескольких однотипных сигналов в массив, если их описания отличаются незначительно.
* Элемент ***section*** - задаёт имя;
* Элемент ***sgroup*** - определяет группу, которая имеет заголовок *header* и находится во вкладке *tab* (ссылка на *id* в разделе **section-tabs**);
* Элемент ***mwidget*** задаёт виджет для данного сигнала (группы сигналов), визуально представляет собой GroupBox с заголовком ***desc***. Вид отображения сигнала (группы сигналов) задаётся параметром ***view***, который может принимать значения: *float*, *bitset* (строка индикаторов в виде кружков);
* Элемент ***start-addr*** - начальный номер сигнала (для группы сигналов) или просто номер отдельного сигнала;
* Элемент *count* - количество сигналов (если больше 1);
* Элемент ***toolTip*** - описание сигнала, появляется при наведении указателя на поле вывода сигнала;
* Элемент *string-array* содержит в себе список строк, подставляемых в описание ***desc*** у ***mwidget*** вместо символа "%1";
* Элементы *item* представляют собой строки для *string-array*.

#### Signals
Раздел с описанием сигналов, передаваемых и принимаемых модулем. Является источником для разделов **iec60870**, **modbus** и **protocom**.
```xml
<signals desc="Сигналы">
	<signal>
		<start-addr>?</start-addr>
		<count>?</count>
		<id>?</id>
		<type>?</type>
	</signal>
</signals>
```
* Элемент ***signal*** определяет группу сигналов;
* Элемент ***start-addr*** задаёт начальный адрес группы сигналов;
* Элемент ***count*** определяет количество сигналов в группе;
* Элемент ***id*** задаёт числовой идентификатор группы для ссылки на него в разделах, описывающих протоколы;
* Элемент ***type*** описывает тип значений, хранящихся в сигналах группы, может принимать значения: *Float*, *BitString* или *SinglePoint*.

#### Specials
Раздел для описания специфических для модуля диалоговых окон и дополнительных параметров, которые не могут быть описаны универсальным способом, представленным выше в соответствующих разделах. Представляет собой перечисление нод с возможными параметрами, наличие которых разрешает отображение соответствующих диалоговых окон и вкладок в основном окне.
```xml
<specials desc="Дополнительно">
	<osc name="?" desc="?"></osc>
	<relay desc="?">
		<count>?</count>
		<control>
			<start-addr>?</start-addr>
		</control>
	</relay>
	<startup desc="?">
		<sgroup header="?">
			<mwidget desc="?" view="?">
				<start-addr>?</start-addr>
				<count>?</count>
				<toolTip>?</toolTip>
				<string-array>
					<item>?</item>
					<item>?</item>
				</string-array>
			</mwidget>
		</sgroup>
	</startup>
	<time desc="?"></time>
	<tune name="?"></tune>
</specials>
```
* Элемент *osc* описывает наличие и тип окна отображения осциллограмм;
* Элемент *relay* задаёт наличие окна команд управления типа "включить/выключить", количество команд управления задаётся в поле *count*, если требуется контроль выдачи команд управления с помощью входных сигналов, задаётся раздел *control* с адресом сигнала, в котором находится результат выполнения команд;
* Элемент *startup* определяет наличие и формат окна задания значений в модуль (не конфигурация!), состав аналогичен виджетам для отображения текущих данных за исключением разницы в наборе возможных значений поля *view* у ноды *mwidget*: *bool* и *edit* для передачи в модуль значений SinglePoint и Float, соответственно;
* Элемент *time* определяет наличие стандартного окна чтения и задания времени в модуле;
* Элемент *tune* описывает наличие и тип окна регулировки модуля.