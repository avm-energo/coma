

# Описание модуля в виде файла XML


## Module

Основная нода описания модуля. В атрибутах ноды *module* обязательно должны быть указаны тип базовой платы и тип мезонинной платы в полях *mtypeb* и *mtypem*, соответственно.

```xml
<module mtypeb="?" mtypem="?">
    <name>?</name>
    <version>?</version>
    <resources>?</resources>
</module>
```

* Элемент *name* отвечает за имя модуля, оно используется для отображения в редакторе модулей в ПО КОМА, обязательный элемент.
* Элемент *version* отвечает за минимальную подходящую версию ВПО модуля для данной конфигурации, записывается в виде `x.yy-zzzz`. 

### Resources

```xml
<resources>
	<alarms desc="Сигнализация"></alarms>
	<config desc="Конфигурация"></config>
	<iec60870 desc="Протокол ГОСТ Р МЭК 60870-5-104"></iec60870>
	<journals desc="Журналы"></journal>
	<modbus desc="Протокол Modbus"></modbus>
	<protocom desc="Протокол Protocom"></protocom>
	<section-tabs desc="Вкладки"></section-tabs>
	<sections desc="Разделы"></sections>
	<signals desc="Сигналы"></signals>
	<special desc="Дополнительно"></special>
</resources>
```

Нода **resources** может содержать:

* Ноду **alarms** - отвечает за сигнализацию;

* Ноду **config** - описывает конфигурацию модуля и всё с ней связанное;

* Ноду **iec60870** - описывает протокол МЭК 60870-5-104;

* Ноду **journals** - отвечает за журналы;

* Ноду **modbus** - описывает протокол Modbus RTU;

* Ноду **protocom** - описывает протокол Протоком;

* Ноду **section-tabs** - описывает владки для отображения текущих данных модуля;

* Ноду **sections** - описывает отображаемые сигналы во вкладках section-tabs;

* Ноду **signals** - описывает сигналы модуля;

* Ноду **special** - описывает диалоги, специфичные для конкретного модуля.

#### Alarms

```xml
	<alarms desc="Сигнализация">
		<critical desc="Критичные"/>
	                <item>
				<addr>?</addr>
				<string>?</string>
				<highlights>
					<item>?</item>
					<item>?</item>
				</highlights>
			</item>
		<warning desc="Предупреждения"/>
		<info desc="Информационные"/>
	</alarm>
```
Нода alarms может иметь секции следующих типов: *critical*, *info* или *warning*.

* Элемент *addr* типа quint32 отвечает за регистр (номер сигнала) сигнализации.
* Элемент *string* представляет собой описание сигнала, отображающееся в списке сигнализаций.
* Элемент *highlights* представляет собой список номеров сигналов, подсветка которых происходит при приходе данной сигнализации. В зависимости от секции - *warn* или *critical*, подсветка производится жёлтым или красным цветом, соответственно.

#### Config

Данный раздел отвечает за конфигурацию и значения по умолчанию для конфигурации.

```xml
<config>
	<record>
		<id>?</id>
		<defaultValue>?</defaultValue>
		<visibility>?</visibility>
		<count>?</count>
	</record>	
</config>
```

Раздел *config* может содержать неограниченное число элементов record, Каждый record соответствует одному элементу в конфигурации. Из всех элементов record формируется список необходимых для отображения элементов.

* Элемент *id* содержит идентификатор, необходим для формирования списка отображаемых элементов.
* Элемент *defaultValue* содержит значение по умолчанию для данного элемента, не обязателен. Если отсутствует, то считается равным 0 или  значению по умолчанию для типа этого элемента.
* Элемент *visibility* влияет на то, отображается данный элемент в диалоге конфигурирования или нет.
* Элемент *count* встречается только у тех записей, которые имеют различное описание у разных модулей с одним и тем же id, и содержит в себе число, характеризующее конкретное количество задаваемых параметров внутри одного элемента. Как пример: модули 0031 и 0033, у которых в параметре с id=235 "типы входов" задаются побитно одинаковым образом, но количество входов разное (11 и 30, соответственно).

#### Iec60870

В данном разделе описываются сигналы с точки зрения работы в протоколе МЭК 60870-5-104, а именно: группы и типы сигналов, а также типы опроса сигналов.

```xml
<iec60870 desc="Протокол ГОСТ Р МЭК 60870-5-104">
	<group>
		<signal-id>?</signal-id>
		<sig-type>?</sig-type>
		<trans-type>?</trans-type>
		<sig-group>?</sig-group>
	</group>
</iec60870>
```

* Элемент *signal-id* ссылается на элемент *id* в разделе **signals**, который описывает группу сигналов модуля;
* Элемент *sig-type* описывает тип сигнала (число) в терминах протокола МЭК 60870-5-104 (7, 30, 13 и т.д.)
* Элемент *trans-type* представляет собой число, характеризующее тип передачи в терминах протокола МЭК 60870-5-104: 0 - опрос группы, 1 - циклическая передача, 3 - спорадика. Элемент может не иметь значения для определённых типов передачи (например, команды)
* Элемент *sig-group* представляет собой номер группы опроса (если *trans-type* = 0)

#### Journals

Раздел описывает журналы, которые имеются в модуле. Журналы бывают трёх типов: Системный (*system*), Измерений (*meas*) и Событий (*work*). 

```xml
<journals desc="Журналы">
	<system desc="Системный журнал">
	</system>
	<meas desc="Журнал измерений">
		<header>?</header>
	</meas>
	<work desc="Рабочий журнал>
		<addr>?</addr>
		<desc>?</desc>
	</work>
</journals>
```
Системный журнал имеет одну и ту же структуру в любом из модулей, поэтому его описание сводится только к его наличию или отсутствию. Наличие определяется тем, есть ли элемент system в ноде journals.
* Элемент *header* должен содержать атрибут name заданной маски, он отвечает за идентификатор журнала;
* Элемент *addr* содержит адрес события, которое передаётся от модуля;
* Элемент *desc* представляет собой описание события для отображения в журнале.

Если любой из журналов отсутствует в модуле (например, журнал измерений в модулях АВ-ТУК), соответствующий элемент (например, meas) должен отсутствовать в разделе journals.

#### Modbus 

Данный элемент описывает использование протокола Modbus RTU. 
```xml
<modbus desc="Протокол Modbus">
	<group>
		<signal-id>?</signal-id>
		<reg-type>?</reg-type>
		<type>?</type>
	</group>
</modbus>
```
* Элемент *signal-id*, как и в разделе *iec60870* ссылается на элемент *id* в разделе **signals**, который описывает группу сигналов модуля;
* Элемент *reg-type* описывает тип регистра в терминах протокола Modbus: 1 (Read Coils), 3 (Read Holding), 4 (Read Input), 5 (Write Coil), 6 (Write Single), 16 (Write Multiple);
* Элемент type содержит тип отображения сигналов в соответствующих окнах, может принимать значения: bool, float, uint32.

#### Protocom

В разделе описываются соответствия номеров блоков, получаемых по интерфейсу USB, и группы сигналов, описываемые в разделе **signals**.
```xml
<protocom desc="Протокол Protocom">
	<group>
		<block>?</block>
		<signal-id>?</signal-id>
	</group>
</protocom>
```
* Элемент *block* представляет собой номер блока, запрашиваемого у модуля;
* Элемент *signal-id*, как и в разделе *iec60870* ссылается на элемент *id* в разделе **signals**, который описывает группу сигналов модуля.

#### 3.1 Group

```xml
<group>
	<function></function>
    <type></type>
    <start-addr></start-addr>
    <count></count>
</group>
```

* Элемент function - функциональный код
* Элемент type - конечный тип получаемого значения
* Элемент start-addr - адрес первого регистра в группе
* Элемент count - количество регистров в группе

#### 3.2 Register

Всё аналогично Group, исключая параметр count. Элемент start-addr становится адресом запрашиваемого регистра.